<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Spring @Service 주요 기능 정리</title>
    <link rel="stylesheet" href="/src/css/study.css">

</head>
<body>
<section>
    <h2>1. @Service의 역할</h2>
    <ul>
        <li>비즈니스 로직을 담당하는 계층(Service Layer)</li>
        <li>Controller와 Repository 사이에서 트랜잭션, 예외 처리, 검증 등을 수행</li>
        <li>스프링 컨테이너가 관리하는 Bean으로 자동 등록(@Component 포함)</li>
    </ul>
</section>

<section>
    <h2>2. 트랜잭션(@Transactional)</h2>
    <p>@Transactional은 메서드 또는 클래스 단위로 선언하며, 하나의 작업 단위를 보장한다.<br>
        예외 발생 시 자동으로 롤백되고, 필요한 경우 지연로딩(Lazy Loading)도 활성화할 수 있다.</p>

    <h3>1) 트랜잭션 기본 동작</h3>
    <ul>
        <li>트랜잭션 시작 → 비즈니스 로직 수행 → 예외 발생 시 롤백 → 정상 완료 시 커밋</li>
        <li>기본적으로 런타임 예외(RuntimeException) 발생 시 자동 롤백</li>
    </ul>

    <pre><code>@Service
@Transactional
public class EmpService {
  public void register(Emp emp) {
    empRepository.save(emp);
    if(emp.getSal() < 0) {
      throw new IllegalArgumentException("급여는 음수일 수 없습니다.");
    }
  }
}</code></pre>

    <p>→ IllegalArgumentException이 발생하면 자동으로 롤백된다.</p>
</section>

<section>
    <h2>3. 트랜잭션 롤백 제어</h2>
    <h3>1) 롤백 조건 지정</h3>
    <pre><code>@Transactional(rollbackFor = Exception.class)
public void updateEmp(Emp emp) throws Exception {
  empRepository.save(emp);
  if(emp.getJob() == null) {
    throw new Exception("직무 정보가 없습니다."); // 체크 예외도 롤백됨
  }
}</code></pre>

    <h3>2) 특정 예외만 롤백 제외</h3>
    <pre><code>@Transactional(noRollbackFor = CustomWarningException.class)
public void modifyEmp(Emp emp) {
  empRepository.save(emp);
  if(emp.getDeptno() == null) {
    throw new CustomWarningException("부서번호가 없어도 진행");
  }
}</code></pre>

    <h3>3) 수동 롤백 처리</h3>
    <p>PlatformTransactionManager를 직접 제어해 롤백할 수도 있다.</p>
    <pre><code>@Service
public class ManualTxService {
  private final PlatformTransactionManager txManager;

  public ManualTxService(PlatformTransactionManager txManager) {
    this.txManager = txManager;
  }

  public void doProcess() {
    TransactionStatus status = txManager.getTransaction(new DefaultTransactionDefinition());
    try {
      // 비즈니스 로직 수행
      txManager.commit(status);
    } catch (Exception e) {
      txManager.rollback(status);
      throw e;
    }
  }
}</code></pre>
</section>

<section>
    <h2>4. 트랜잭션과 지연 로딩(Lazy Loading)</h2>
    <p>엔티티 관계를 <code>FetchType.LAZY</code>로 설정한 경우, 실제 객체 조회는 트랜잭션 내에서 프록시가 동작할 때 실행된다.</p>

    <h3>1) Service에서 Lazy 로딩 처리</h3>
    <pre><code>@Transactional(readOnly = true)
public Dept findDeptWithEmp(Long deptno) {
  Dept dept = deptRepository.findById(deptno)
      .orElseThrow(() -> new EntityNotFoundException("부서를 찾을 수 없음"));
  dept.getEmps().size(); // 트랜잭션 내부에서 프록시 초기화
  return dept;
}</code></pre>

    <ul>
        <li>트랜잭션 범위 안에서는 지연 로딩이 동작한다.</li>
        <li>트랜잭션이 닫힌 후(view나 controller에서 접근 시)는 LazyInitializationException 발생</li>
    </ul>

    <h3>2) View에서 Lazy 로딩 방지</h3>
    <p>Fetch Join 또는 DTO 변환으로 미리 로딩해 반환하는 것이 일반적이다.</p>
    <pre><code>@Query("SELECT d FROM Dept d JOIN FETCH d.emps WHERE d.deptno = :deptno")
Dept findDeptFetch(@Param("deptno") Long deptno);</code></pre>

    <h3>3) 테스트나 비트랜잭션 환경에서 Lazy 로딩</h3>
    <p>테스트 시 <code>@Transactional</code>을 메서드에 붙이거나, Service 내부에서 데이터 접근을 트랜잭션으로 감싸야 한다.</p>
</section>

<section>
    <h2>5. 기타 서비스 계층 기능</h2>
    <ul>
        <li><strong>@Async</strong> – 비동기 서비스 실행 (별도 스레드로 로직 처리)</li>
        <li><strong>@Cacheable</strong> – 자주 호출되는 결과 캐싱 (조회 성능 향상)</li>
        <li><strong>@Validated</strong> – 입력값 검증 (Bean Validation)</li>
        <li><strong>이벤트 발행(ApplicationEventPublisher)</strong> – 비즈니스 로직 후처리 (예: 회원가입 후 이메일 전송)</li>
        <li><strong>예외 변환(Exception Translation)</strong> – Repository 예외를 의미 있는 비즈니스 예외로 변환</li>
    </ul>
</section>

<section>
    <h2>6. 정리</h2>
    <ul>
        <li>@Service는 비즈니스 로직 담당 계층으로, 트랜잭션과 함께 핵심 로직을 처리한다.</li>
        <li>@Transactional로 트랜잭션 시작, 롤백, 지연로딩까지 관리할 수 있다.</li>
        <li>조회용은 readOnly 속성을 통해 성능 최적화 가능 (<code>@Transactional(readOnly = true)</code>)</li>
        <li>트랜잭션이 끊기면 Lazy 로딩은 작동하지 않는다.</li>
        <li>비동기(@Async), 캐시(@Cacheable), 검증(@Validated) 등도 자주 함께 사용된다.</li>
    </ul>
</section>
</body>
</html>